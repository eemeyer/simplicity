<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-us" xml:lang="en-us">
  <head>
    <title>JSON Query Tool</title>
    <link href="../css/lib/yui-grids-min-3.2.0.css" rel="stylesheet" type="text/css" />
    <link href="../css/lib/jquery-ui-1.8.7.custom.css" rel="stylesheet" type="text/css" />
    <link href="slickgrid-df064f/slick.grid.css" rel="stylesheet" type="text/css" />
    <link href="slickgrid-df064f/controls/slick.columnpicker.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" href="../images/favicon.jpg"/>
    <style>
      body {
        margin: auto; /* center in viewport */
        width: 960px;
        font-size:62.5%;
      }
  </style>
  </head>
  <body>
    <form onsubmit="return false;">
      <div id="results" style="width:100%;height:300px;display:none;">
      </div>
      <div id="main" class="yui3-u">
        <div class="yui3-g">
          <div class="yui3-u-1-2">
            <fieldset class="ui-widget">
              <legend>Request</legend>
              <textarea rows="10" cols="68" id="request">
{
  "criteria": [
    {
    }
  ],
  "properties": [],
  "pageSize": 10
}
              </textarea>
              <div></div>
              <button name="search" type="button">Search</button>
              <input type="checkbox" id="keepColumns"/> <label for="keepColumns">Keep column names and order</label>
            </fieldset>
            <div id="requestMsg"></div>
          </div>
          <div class="yui3-u-1-2">
            <fieldset class="ui-widget">
              <legend>Response</legend>
              <textarea rows="10" cols="68" id="response"></textarea>
            </fieldset>
          </div>
        </div>
      </div>
    </form>
    <script type="text/javascript" src="../js/lib/jquery-1.5.1.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/lib/jquery-ui-1.8.7.custom.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/lib/jquery.ba-bbq-1.2.1.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/lib/json2.js" charset="utf-8"></script>
    <script type="text/javascript" src="slickgrid-df064f/lib/jquery.event.drag-2.0.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="slickgrid-df064f/slick.core.js" charset="utf-8"></script>
    <script type="text/javascript" src="slickgrid-df064f/slick.grid.js" charset="utf-8"></script>
    <script type="text/javascript" src="slickgrid-df064f/controls/slick.columnpicker.js" charset="utf-8"></script>
    <script type="text/javascript" src="simplicityLargeContentViewer.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/simplicity/simplicityDiscoverySearch.js" charset="utf-8"></script>
    <script type="text/javascript"><!--//<![CDATA[
      $('fieldset').addClass("ui-widget ui-widget-content");

      $('body')
        .simplicityDiscoverySearch({
          url: 'query_proxy.php'
        });
      // json request widget
      $('#request').bind('focus', function (evt, ui) {
        $('#requestMsg').hide(500);
      });

      $('button[name="search"]').bind('click', function (evt, ui) {
        var input = $('#request');
        var raw =  input.val();
        var validJson = false;
        try
        {
          var search = JSON.parse(raw)
          var pretty = JSON.stringify(search, null, '  ');
          validJson = true;
        }
        catch (e)
        {
          $('#requestMsg').text('Invalid JSON').show(500);
        }
        if (validJson)
        {
          input.val(pretty);
          $('button[name="search"]').attr('disabled', 'disabled');
          $('body').simplicityDiscoverySearch('query', raw);
        }
      });
      $('body').bind('simplicitySearchResponse', function (evt, ui) {
        $('button[name="search"]').removeAttr('disabled');
      });

      // json response widget
      $('body').bind('simplicitySearchResponse', function (evt, ui) {
        $('#response').val(JSON.stringify(ui._discovery.response, null, '  '));
      });

      var grid = new Slick.Grid($('#results'), [], [], {});
      // json response properties widget
      $('body').bind('simplicityResultSet', function (evt, result) {
        // TODO: display top level result properties: datasetSize, exactSize, numRows, pageSize.
        var rows = result.rows
        var colNamesMap = {};
        var colNames = [];
        // could derive this while looping, but this way we control the order.
        var rowPropNames = ['id', 'score', 'exact'];
        $.each(rows, function (idx, row) {
          if (row.properties) {
            $.each(row.properties, function (propName, propValue) {
              if (!colNamesMap[propName]) {
                colNames.push(propName);
                colNamesMap[propName] = 1;
              }
            });
          }
        });
        delete colNamesMap;

        var data = [];
        $.each(rows, function (idx, row) {
          var item = $.extend({}, row);
          delete item.properties;
          $.extend(item, row.properties);
          data.push(item);
        });

        var columns = grid.getColumns();
        if ($('#keepColumns').is(':not(:checked)') || columns.length === 0)
        {
          columns = [];
          $.each($.merge($.merge([], rowPropNames), colNames), function (idx, name) {
            columns.push({id: name, name: name, field: name, resizable: true, selectable: false,
              editor:simplicityLargeContentViewer})
          });
        }
        grid.destroy();
        $(results).show();
        var options = {enableCellNavigation: true, forceFitColumns: true, editable: true};
        grid = new Slick.Grid($('#results'), data, columns, options);
        new Slick.Controls.ColumnPicker(columns, grid, {});
      });
    //]]>--></script>
  </body>
</html>
